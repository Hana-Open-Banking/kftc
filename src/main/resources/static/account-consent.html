<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê³„ì¢Œ ì—°ë™ ë™ì˜</title>
    <script>
        // ì „ì—­ ë³€ìˆ˜ ì„ ì–¸
        let userSeqNo, userCi, sessionId;

        // í˜ì´ì§€ ì´ˆê¸°í™”
        window.addEventListener('DOMContentLoaded', function() {
            console.log('JavaScript ì´ˆê¸°í™” ì‹œì‘');
            
            // URL íŒŒë¼ë¯¸í„°ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const urlParams = new URLSearchParams(window.location.search);
            userSeqNo = urlParams.get('userSeqNo');
            userCi = urlParams.get('userCi');
            sessionId = urlParams.get('sessionId');
            
            console.log('ì „ì²´ URL:', window.location.href);
            console.log('URL íŒŒë¼ë¯¸í„°:', {
                userSeqNo: userSeqNo,
                userCi: userCi ? userCi.substring(0, 10) + '...' : null,
                sessionId: sessionId,
                raw: window.location.search
            });

            if (userSeqNo && userCi) {
                console.log('ê³„ì¢Œ ëª©ë¡ ì¡°íšŒ ì‹œì‘ - íŒŒë¼ë¯¸í„° í™•ì¸:', {
                    userSeqNo: userSeqNo,
                    userCi: userCi ? userCi.substring(0, 10) + '...' : null
                });
                loadAccountList();
            } else {
                console.error('í•„ìˆ˜ íŒŒë¼ë¯¸í„° ëˆ„ë½:', {
                    userSeqNo: !!userSeqNo,
                    userCi: !!userCi
                });
                showError('ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì¸ì¦í•´ì£¼ì„¸ìš”.');
            }
        });

        // ì „ì²´ ì„ íƒ
        function selectAll() {
            console.log('ì „ì²´ ì„ íƒ ì‹¤í–‰');
            const checkboxes = document.querySelectorAll('#accountList input[type="checkbox"]');
            checkboxes.forEach(checkbox => checkbox.checked = true);
        }

        // ì „ì²´ í•´ì œ
        function deselectAll() {
            console.log('ì „ì²´ í•´ì œ ì‹¤í–‰');
            const checkboxes = document.querySelectorAll('#accountList input[type="checkbox"]');
            checkboxes.forEach(checkbox => checkbox.checked = false);
        }

        // ê³„ì¢Œ ëª©ë¡ ë¡œë“œ
        function loadAccountList() {
            console.log('ê³„ì¢Œ ëª©ë¡ ë¡œë“œ ì‹œì‘');
            fetch('/api/phone-verification/discover-accounts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    userSeqNo: userSeqNo,
                    userCi: userCi
                })
            })
            .then(response => {
                console.log('API ì‘ë‹µ ìƒíƒœ:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('API ì‘ë‹µ ë°ì´í„°:', data);
                console.log('API ì‘ë‹µ ìƒíƒœ:', data.status);
                console.log('API ì‘ë‹µ ë©”ì‹œì§€:', data.message);
                console.log('API ì‘ë‹µ ë°ì´í„° ë‚´ìš©:', data.data);
                
                if (data.status === 200) {
                    console.log('ê³„ì¢Œ ëª©ë¡ í‘œì‹œ ì‹œì‘, institutions ê°œìˆ˜:', data.data ? data.data.length : 0);
                    displayAccountList(data.data);
                } else {
                    console.error('API ì‘ë‹µ ì—ëŸ¬:', data.message);
                    showError('ê³„ì¢Œ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + data.message);
                }
            })
            .catch(error => {
                console.error('API í˜¸ì¶œ ì—ëŸ¬:', error);
                showError('ê³„ì¢Œ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
        }

        // ê³„ì¢Œ ëª©ë¡ í‘œì‹œ
        function displayAccountList(institutions) {
            console.log('ê³„ì¢Œ ëª©ë¡ í‘œì‹œ ì‹œì‘ - institutions:', institutions);
            const accountListDiv = document.getElementById('accountList');
            const buttonsDiv = document.querySelector('.buttons');
            accountListDiv.innerHTML = '';

            if (!institutions || institutions.length === 0) {
                console.log('ì—°ë™ ê°€ëŠ¥í•œ ê³„ì¢Œê°€ ì—†ìŠµë‹ˆë‹¤.');
                accountListDiv.innerHTML = `
                    <div class="no-accounts-message">
                        <p>ğŸ¦ ì—°ë™ ê°€ëŠ¥í•œ ê³„ì¢Œê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
                        <p>ê³„ì¢Œ ì—°ë™ ì—†ì´ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
                
                // ë²„íŠ¼ì„ "ê³„ì¢Œ ì—†ì´ ì§„í–‰"ìœ¼ë¡œ ë³€ê²½
                buttonsDiv.innerHTML = `
                    <button class="btn btn-primary" onclick="proceedWithoutAccounts()">ê³„ì¢Œ ì—†ì´ ì§„í–‰</button>
                `;
                return;
            }

            let totalAccountsAdded = 0;

            institutions.forEach((institution, institutionIndex) => {
                console.log(`Institution ${institutionIndex}:`, institution);
                console.log(`Institution ${institutionIndex} accountList:`, institution.accountList);
                
                if (institution.accountList && institution.accountList.length > 0) {
                    console.log(`Institution ${institutionIndex} ê³„ì¢Œ ê°œìˆ˜:`, institution.accountList.length);
                    
                    institution.accountList.forEach((account, accountIndex) => {
                        console.log(`ê³„ì¢Œ ${institutionIndex}-${accountIndex}:`, account);
                        
                        const accountDiv = document.createElement('div');
                        accountDiv.className = 'account-item';
                        
                        const accountTypeText = getAccountTypeText(account.accountType);
                        
                        accountDiv.innerHTML = `
                            <input type="checkbox" id="account_${account.fintechUseNum}" 
                                   value="${account.fintechUseNum}" 
                                   data-bank-code="${institution.bankCode}"
                                   data-service-type="${institution.serviceType}"
                                   data-account-num="${account.accountNum || ''}"
                                   data-account-alias="${account.accountAlias || account.accountHolderName}"
                                   data-bank-name="${account.bankName}"
                                   data-account-num-masked="${account.accountNumMasked}"
                                   data-account-holder-name="${account.accountHolderName}"
                                   data-account-type="${account.accountType}"
                                   data-inquiry-agree-yn="${account.inquiryAgreeYn || 'Y'}"
                                   data-transfer-agree-yn="${account.transferAgreeYn || 'Y'}"
                                   data-payer-num="${account.payerNum || ''}">
                            <div class="account-info">
                                <div class="account-name">
                                    ${account.accountAlias || account.accountHolderName}
                                    <span class="account-type">${accountTypeText}</span>
                                </div>
                                <div class="account-details">
                                    ${account.bankName} | ${account.accountNumMasked}<br>
                                    ì˜ˆê¸ˆì£¼: ${account.accountHolderName}
                                </div>
                            </div>
                        `;
                        
                        accountListDiv.appendChild(accountDiv);
                        totalAccountsAdded++;
                        console.log(`ê³„ì¢Œ ì¶”ê°€ë¨: ${account.accountAlias}, ì´ ${totalAccountsAdded}ê°œ`);
                    });
                } else {
                    console.log(`Institution ${institutionIndex}ì— ê³„ì¢Œê°€ ì—†ìŠµë‹ˆë‹¤.`);
                }
            });
            
            console.log('ê³„ì¢Œ ëª©ë¡ í‘œì‹œ ì™„ë£Œ - ì´ ê³„ì¢Œ ìˆ˜:', totalAccountsAdded);
            
            if (totalAccountsAdded === 0) {
                accountListDiv.innerHTML = `
                    <div class="no-accounts-message">
                        <p>ğŸ¦ í‘œì‹œí•  ìˆ˜ ìˆëŠ” ê³„ì¢Œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                        <p>ê³„ì¢Œ ì—°ë™ ì—†ì´ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
                
                // ë²„íŠ¼ì„ "ê³„ì¢Œ ì—†ì´ ì§„í–‰"ìœ¼ë¡œ ë³€ê²½
                const buttonsDiv = document.querySelector('.buttons');
                buttonsDiv.innerHTML = `
                    <button class="btn btn-primary" onclick="proceedWithoutAccounts()">ê³„ì¢Œ ì—†ì´ ì§„í–‰</button>
                `;
            } else {
                // ê³„ì¢Œê°€ ìˆì„ ë•Œ ë²„íŠ¼ì— "ê³„ì¢Œ ì—†ì´ ì§„í–‰" ì˜µì…˜ ì¶”ê°€
                const buttonsDiv = document.querySelector('.buttons');
                buttonsDiv.innerHTML = `
                    <button class="btn btn-secondary" onclick="selectAll()">ì „ì²´ ì„ íƒ</button>
                    <button class="btn btn-secondary" onclick="deselectAll()">ì „ì²´ í•´ì œ</button>
                    <button class="btn btn-primary" onclick="saveSelectedAccounts()">ì„ íƒí•œ ê³„ì¢Œ ì—°ë™</button>
                    <button class="btn btn-outline" onclick="proceedWithoutAccounts()">ê³„ì¢Œ ì—†ì´ ì§„í–‰</button>
                `;
            }
        }

        // ê³„ì¢Œ ìœ í˜• í…ìŠ¤íŠ¸ ë³€í™˜
        function getAccountTypeText(accountType) {
            switch(accountType) {
                case '1': return 'ì¼ë°˜ê³„ì¢Œ';
                case '2': return 'ì •ê¸°ì˜ˆê¸ˆ';
                case 'CARD': return 'ì¹´ë“œ';
                case 'INSURANCE': return 'ë³´í—˜';
                default: return 'ê¸°íƒ€';
            }
        }

        // ì„ íƒí•œ ê³„ì¢Œ ì €ì¥
        function saveSelectedAccounts() {
            console.log('ì„ íƒí•œ ê³„ì¢Œ ì €ì¥ ì‹œì‘');
            const selectedCheckboxes = document.querySelectorAll('#accountList input[type="checkbox"]:checked');
            
            if (selectedCheckboxes.length === 0) {
                alert('ì—°ë™í•  ê³„ì¢Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const selectedAccounts = [];
            selectedCheckboxes.forEach(checkbox => {
                console.log('ì²´í¬ë°•ìŠ¤ ë°ì´í„°:', checkbox.dataset);
                
                selectedAccounts.push({
                    fintechUseNum: checkbox.value,
                    bankCode: checkbox.dataset.bankCode,
                    serviceType: checkbox.dataset.serviceType,
                    accountNum: checkbox.dataset.accountNum,
                    accountAlias: checkbox.dataset.accountAlias,
                    bankName: checkbox.dataset.bankName,
                    accountNumMasked: checkbox.dataset.accountNumMasked,
                    accountHolderName: checkbox.dataset.accountHolderName,
                    accountType: checkbox.dataset.accountType,
                    inquiryAgreeYn: checkbox.dataset.inquiryAgreeYn,
                    transferAgreeYn: checkbox.dataset.transferAgreeYn,
                    payerNum: checkbox.dataset.payerNum
                });
            });

            // ë¡œë”© í‘œì‹œ
            document.getElementById('loading').style.display = 'block';
            document.getElementById('result').style.display = 'none';

            console.log('ì„ íƒëœ ê³„ì¢Œ ì •ë³´:', selectedAccounts);

            // ì„œë²„ì— ì„ íƒí•œ ê³„ì¢Œ ì €ì¥ ìš”ì²­
            fetch('/api/phone-verification/save-selected-accounts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    userSeqNo: userSeqNo,
                    selectedAccounts: selectedAccounts
                })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('loading').style.display = 'none';
                console.log('ê³„ì¢Œ ì €ì¥ ì‘ë‹µ:', data);
                
                if (data.status === 200) {
                    showSuccess(`${data.data.savedCount}ê°œì˜ ê³„ì¢Œê°€ ì„±ê³µì ìœ¼ë¡œ ì—°ë™ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    
                    // OAuth í”Œë¡œìš° ì™„ë£Œ - ì„œë¹„ìŠ¤ ë™ì˜ ì²˜ë¦¬
                    if (sessionId) {
                        setTimeout(function() {
                            completeOAuthFlow();
                        }, 2000);
                    }
                } else {
                    showError('ê³„ì¢Œ ì—°ë™ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + data.message);
                }
            })
            .catch(error => {
                document.getElementById('loading').style.display = 'none';
                console.error('Error:', error);
                showError('ê³„ì¢Œ ì—°ë™ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        }

        // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
        function showSuccess(message) {
            const resultDiv = document.getElementById('result');
            const messageDiv = document.getElementById('resultMessage');
            
            resultDiv.className = 'result success';
            messageDiv.textContent = message;
            resultDiv.style.display = 'block';
        }

        // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
        function showError(message) {
            const resultDiv = document.getElementById('result');
            const messageDiv = document.getElementById('resultMessage');
            
            resultDiv.className = 'result error';
            messageDiv.textContent = message;
            resultDiv.style.display = 'block';
        }

        // ê³„ì¢Œ ì—†ì´ ì§„í–‰
        function proceedWithoutAccounts() {
            if (!sessionId) {
                console.log('sessionIdê°€ ì—†ì–´ ì§„í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                showError('ì„¸ì…˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì¸ì¦í•´ì£¼ì„¸ìš”.');
                return;
            }

            console.log('ê³„ì¢Œ ì—†ì´ ì§„í–‰ ì‹œì‘');
            
            // ë¡œë”© í‘œì‹œ
            document.getElementById('loading').style.display = 'block';
            document.getElementById('result').style.display = 'none';

            // Formì„ ì‚¬ìš©í•˜ì—¬ POST ìš”ì²­
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/oauth/consent/skip-accounts';
            
            // session_id íŒŒë¼ë¯¸í„° ì¶”ê°€
            const sessionInput = document.createElement('input');
            sessionInput.type = 'hidden';
            sessionInput.name = 'session_id';
            sessionInput.value = sessionId;
            form.appendChild(sessionInput);
            
            // Formì„ DOMì— ì¶”ê°€í•˜ê³  ì œì¶œ
            document.body.appendChild(form);
            
            console.log('ê³„ì¢Œ ì—†ì´ ë™ì˜ í™”ë©´ìœ¼ë¡œ ì´ë™');
            showSuccess('ê³„ì¢Œ ì—†ì´ ì„œë¹„ìŠ¤ ë™ì˜ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤...');
            setTimeout(() => {
                form.submit();
            }, 1000);
        }

        // OAuth í”Œë¡œìš° ì™„ë£Œ
        function completeOAuthFlow() {
            if (!sessionId) {
                console.log('sessionIdê°€ ì—†ì–´ OAuth í”Œë¡œìš°ë¥¼ ì™„ë£Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            console.log('OAuth í”Œë¡œìš° ì™„ë£Œ ì‹œì‘');
            showSuccess('ğŸ‰ ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! í´ë¼ì´ì–¸íŠ¸ ì•±ìœ¼ë¡œ ì´ë™ë©ë‹ˆë‹¤.');
            
            // Formì„ ì‚¬ìš©í•˜ì—¬ POST ìš”ì²­ ë° ìë™ ë¦¬ë””ë ‰ì…˜ ì²˜ë¦¬
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/oauth/consent';
            
            // session_id íŒŒë¼ë¯¸í„° ì¶”ê°€
            const sessionInput = document.createElement('input');
            sessionInput.type = 'hidden';
            sessionInput.name = 'session_id';
            sessionInput.value = sessionId;
            form.appendChild(sessionInput);
            
            // agreed íŒŒë¼ë¯¸í„° ì¶”ê°€
            const agreedInput = document.createElement('input');
            agreedInput.type = 'hidden';
            agreedInput.name = 'agreed';
            agreedInput.value = 'true';
            form.appendChild(agreedInput);
            
            // Formì„ DOMì— ì¶”ê°€í•˜ê³  ì œì¶œ
            document.body.appendChild(form);
            
            console.log('OAuth ë™ì˜ Form ì œì¶œ ì‹œì‘');
            setTimeout(() => {
                form.submit();
            }, 2000);
        }
    </script>
    <style>
        body {
            font-family: 'Malgun Gothic', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .info-box {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #2196F3;
        }
        .account-list {
            margin: 20px 0;
        }
        .account-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            transition: background-color 0.2s;
        }
        .account-item:hover {
            background-color: #f8f9fa;
        }
        .account-item input[type="checkbox"] {
            margin-right: 15px;
            transform: scale(1.2);
        }
        .account-info {
            flex: 1;
        }
        .account-name {
            font-weight: bold;
            font-size: 16px;
            color: #333;
            margin-bottom: 5px;
        }
        .account-details {
            font-size: 14px;
            color: #666;
            line-height: 1.4;
        }
        .account-type {
            display: inline-block;
            background: #e3f2fd;
            color: #1976d2;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 10px;
        }
        .buttons {
            text-align: center;
            margin-top: 30px;
        }
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin: 0 10px;
            transition: background-color 0.3s;
        }
        .btn-primary {
            background-color: #2196F3;
            color: white;
        }
        .btn-primary:hover {
            background-color: #1976D2;
        }
        .btn-secondary {
            background-color: #f5f5f5;
            color: #333;
        }
        .btn-secondary:hover {
            background-color: #e0e0e0;
        }
        .btn-outline {
            background-color: transparent;
            color: #2196F3;
            border: 2px solid #2196F3;
        }
        .btn-outline:hover {
            background-color: #2196F3;
            color: white;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2196F3;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .result {
            display: none;
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
        }
        .result.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .result.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .no-accounts-message {
            text-align: center;
            padding: 40px 20px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            margin: 20px 0;
        }
        .no-accounts-message p {
            margin: 10px 0;
            color: #856404;
            font-size: 16px;
        }
        .no-accounts-message p:first-child {
            font-weight: bold;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ê³„ì¢Œ ì—°ë™ ë™ì˜</h1>
        
        <div class="info-box">
            <strong>ì•ˆë‚´ì‚¬í•­</strong><br>
            ì•„ë˜ ê³„ì¢Œë“¤ì€ ê·€í•˜ì˜ íœ´ëŒ€í° ì¸ì¦ì„ í†µí•´ í™•ì¸ëœ ê³„ì¢Œì…ë‹ˆë‹¤.<br>
            ì—°ë™ì„ ì›í•˜ëŠ” ê³„ì¢Œë¥¼ ì„ íƒí•˜ì‹  í›„ 'ì„ íƒí•œ ê³„ì¢Œ ì—°ë™' ë²„íŠ¼ì„ í´ë¦­í•´ì£¼ì„¸ìš”.
        </div>

        <div id="accountList" class="account-list">
            <!-- ê³„ì¢Œ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>

        <div class="buttons">
            <button class="btn btn-secondary" onclick="selectAll()">ì „ì²´ ì„ íƒ</button>
            <button class="btn btn-secondary" onclick="deselectAll()">ì „ì²´ í•´ì œ</button>
            <button class="btn btn-primary" onclick="saveSelectedAccounts()">ì„ íƒí•œ ê³„ì¢Œ ì—°ë™</button>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>ì„ íƒí•œ ê³„ì¢Œë¥¼ ì €ì¥í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
        </div>

        <div id="result" class="result">
            <p id="resultMessage"></p>
        </div>
    </div>
</body>
</html> 